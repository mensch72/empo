services:
  empo-dev:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        DEV_MODE: "true"
        USER_ID: ${USER_ID:-1000}
        GROUP_ID: ${GROUP_ID:-1000}
        HIERARCHICAL_MODE: ${HIERARCHICAL_MODE:-false}
    image: empo:dev
    pull_policy: build
    container_name: empo-dev
    
    volumes:
      - .:/workspace
      - pip-cache:/home/appuser/.cache/pip
    
    stdin_open: true
    tty: true
    
    ports:
      - "8888:8888"
      - "6006:6006"
      - "5678:5678"
    
    working_dir: /workspace
    
    environment:
      - WANDB_API_KEY=${WANDB_API_KEY:-}
      - PYTHONPATH=/workspace:/workspace/vendor/multigrid
      - OLLAMA_HOST=${OLLAMA_HOST:-http://ollama:11434}
    
    command: /bin/bash

  # Optional Ollama service for local LLM inference
  # Start with: HIERARCHICAL_MODE=true docker compose --profile hierarchical up -d
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    profiles:
      - hierarchical
    ports:
      - "11434:11434"
    volumes:
      - ollama-models:/root/.ollama
    # Uncomment the following for GPU support:
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]

  # MineLand Minecraft simulator container (alternative to running MineLand in empo-dev)
  # Uses official MineLand Docker image with Minecraft server managed internally
  # Port 25565 is exposed for connecting Minecraft clients (optional debugging)
  # 
  # You can either:
  # 1. Run MineLand tests in empo-dev container (MineLand is pre-installed)
  # 2. Use this dedicated mineland container for more isolation
  mineland:
    image: yxhxianyu/mineland:latest
    container_name: mineland
    profiles:
      - hierarchical
    ports:
      - "25565:25565"  # Minecraft server port (for optional vanilla client connection)
    volumes:
      - mineland-data:/root/MineLand/data  # Persist world data
      - .:/workspace:ro  # Mount workspace read-only to access test scripts
    environment:
      - DISPLAY=:1
      - OLLAMA_HOST=http://ollama:11434  # For integration tests with Ollama
    working_dir: /root/MineLand
    # Start Xvfb for headless display, then keep container running
    command: >
      /bin/bash -c "
        Xvfb :1 -screen 0 1024x768x24 </dev/null &
        sleep 2 &&
        echo 'MineLand container ready. Run validation with:' &&
        echo '  docker exec mineland python scripts/validate_install_simulator.py' &&
        echo 'Or run integration test with:' &&
        echo '  make test-mineland-integration' &&
        tail -f /dev/null
      "
    # Health check to ensure Xvfb is running
    healthcheck:
      test: ["CMD", "pgrep", "Xvfb"]
      interval: 10s
      timeout: 5s
      retries: 3
    # Ensure mineland can reach ollama container
    depends_on:
      - ollama

volumes:
  pip-cache:
  ollama-models:
  mineland-data:
