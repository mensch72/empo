services:
  empo-dev:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        DEV_MODE: "true"
        USER_ID: ${USER_ID:-1000}
        GROUP_ID: ${GROUP_ID:-1000}
        HIERARCHICAL_MODE: ${HIERARCHICAL_MODE:-false}
    image: empo:dev
    pull_policy: build
    container_name: empo-dev
    
    volumes:
      - .:/workspace
      - pip-cache:/home/appuser/.cache/pip
    
    stdin_open: true
    tty: true
    
    ports:
      - "8888:8888"
      - "6006:6006"
      - "5678:5678"
    
    working_dir: /workspace
    
    environment:
      - WANDB_API_KEY=${WANDB_API_KEY:-}
      - PYTHONPATH=/workspace:/workspace/vendor/multigrid
      - OLLAMA_HOST=${OLLAMA_HOST:-http://ollama:11434}
      # MineLand server host for Simulation Mode (connects to mineland container)
      - MINELAND_SERVER_HOST=${MINELAND_SERVER_HOST:-mineland}
      - MINELAND_SERVER_PORT=${MINELAND_SERVER_PORT:-25565}
    
    command: /bin/bash

  # Optional Ollama service for local LLM inference
  # Start with: HIERARCHICAL_MODE=true docker compose --profile hierarchical up -d
  ollama:
    image: ollama/ollama:latest
    container_name: ollama
    profiles:
      - hierarchical
    ports:
      - "11434:11434"
    volumes:
      - ollama-models:/root/.ollama
    # Uncomment the following for GPU support:
    # deploy:
    #   resources:
    #     reservations:
    #       devices:
    #         - driver: nvidia
    #           count: all
    #           capabilities: [gpu]

  # MineLand container - runs Minecraft server for empo-dev to connect to
  # 
  # Architecture:
  # - mineland: Runs Minecraft server via MineLand (port 25565)
  # - empo-dev: Your Python RL/planning code connects via MineLand client
  # - ollama: LLM server
  #
  # Your code in empo-dev uses MineLand to connect to mineland:25565
  mineland:
    image: yxhxianyu/mineland:latest
    container_name: mineland
    profiles:
      - hierarchical
    ports:
      - "25565:25565"  # Minecraft server port
    volumes:
      - mineland-data:/root/MineLand/data  # Persist world data
      - .:/workspace:ro  # Mount workspace read-only for validation scripts
    environment:
      - DISPLAY=:1
    working_dir: /root/MineLand
    # Start Xvfb and run a MineLand environment that acts as a server
    # This spawns Minecraft and keeps it running for external connections
    command: >
      /bin/bash -c "
        echo 'Starting MineLand Minecraft server...' &&
        Xvfb :1 -screen 0 1024x768x24 </dev/null &
        sleep 2 &&
        echo 'Xvfb started on DISPLAY=:1' &&
        echo '' &&
        echo 'Starting Minecraft server via MineLand...' &&
        python -c \"
import mineland
import time
import signal
import sys

def signal_handler(sig, frame):
    print('Shutting down...')
    sys.exit(0)

signal.signal(signal.SIGTERM, signal_handler)
signal.signal(signal.SIGINT, signal_handler)

print('Creating MineLand environment (spawns Minecraft server)...')
print('This will take 1-2 minutes on first run...')

try:
    env = mineland.make(
        task_id='playground',
        agents_count=1,
        headless=True,
    )
    print('âœ“ Minecraft server started!')
    print('Server accessible at mineland:25565 from empo-dev')
    print('')
    print('Keeping server alive...')
    
    # Keep the environment alive
    obs = env.reset()
    while True:
        action = [mineland.Action()]
        obs, code_info, event, done, task_info = env.step(action)
        time.sleep(1)
except Exception as e:
    print(f'Error: {e}')
    import traceback
    traceback.print_exc()
    # Keep container running for debugging
    while True:
        time.sleep(60)
\" 2>&1
      "
    # Health check - verify Minecraft is responding
    healthcheck:
      test: ["CMD", "bash", "-c", "timeout 5 bash -c '</dev/tcp/localhost/25565' 2>/dev/null"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 180s  # Give 3 minutes for Minecraft to start

volumes:
  pip-cache:
  ollama-models:
  mineland-data:
