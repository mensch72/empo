services:
  empo-dev:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        # Enable dev mode to install development dependencies
        DEV_MODE: "true"
        # Match host user ID for file permissions
        USER_ID: ${USER_ID:-1000}
        GROUP_ID: ${GROUP_ID:-1000}
    image: empo:dev
    container_name: empo-dev
    
    # GPU support - automatically uses GPUs if available
    # Requires nvidia-docker2 and NVIDIA Container Toolkit installed
    # Note: 'count: all' reserves all GPUs. To use specific GPUs, set CUDA_VISIBLE_DEVICES
    # environment variable or change 'count: all' to 'count: 1' (or specific number)
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    
    # Bind mount the repository for live development
    volumes:
      - .:/workspace
      # Optional: persist pip cache
      - pip-cache:/home/appuser/.cache/pip
    
    # Keep container running for interactive development
    stdin_open: true
    tty: true
    
    # Optional: expose ports for debugging, Jupyter, TensorBoard, etc.
    ports:
      - "8888:8888"  # Jupyter
      - "6006:6006"  # TensorBoard
      - "5678:5678"  # Python debugger (debugpy)
    
    # Set working directory
    working_dir: /workspace
    
    # Optional: pass environment variables
    environment:
      - CUDA_VISIBLE_DEVICES=${CUDA_VISIBLE_DEVICES:-all}
      - WANDB_API_KEY=${WANDB_API_KEY:-}
      - PYTHONPATH=/workspace:/workspace/vendor/multigrid
    
    # Default command
    command: /bin/bash

volumes:
  pip-cache:
